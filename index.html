<!-- ===============================================================
     Jobstronaut™ Frontend
     Author: Alise McNiel
     Copyright (c) 2025 Alise McNiel. All rights reserved.
     This software is part of the Jobstronaut™ project.
     Unauthorized copying, modification, or distribution is prohibited.
     =============================================================== -->
<!DOCTYPE html>
<html lang="en" data-darkreader-mode="dynamic" data-darkreader-scheme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JOBSTRONAUT V2</title>

  <!--
  ======================================================================
   Jobstronaut™ Frontend — (c) 2025 Alise McNiel. All rights reserved.
  ======================================================================
  -->

  <!-- Keep your existing CSS; this matches your current look -->
  <style>
    :root { --accent:#ff9b00; --ink:#e7e7f0; --muted:#9ca3af; }
    html,body{margin:0;padding:0;background:#0b0f1a;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:56px auto;padding:0 16px}
    .title{font-weight:900;letter-spacing:.02em;margin:0 0 8px;font-size:48px}
    .tagline{color:var(--muted);max-width:720px;margin:0 0 24px}
    .grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media (min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid rgba(255,255,255,.08);background:radial-gradient(1200px 600px at 20% -20%, #1a2140 0%, #0f1427 60%, #0b0f1a 100%);border-radius:18px;padding:24px}
    .chip{display:inline-block;background:rgba(255,155,0,.12);color:#ffb44d;border:1px solid rgba(255,155,0,.35);padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;margin-bottom:12px}
    .label{font-size:14px;color:var(--muted);margin:16px 0 6px}
    .input,.email{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:12px 14px;color:var(--ink);outline:none}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .btn{border:0;border-radius:14px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#ff9b00,#ffb84d);color:#2a1800}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--ink)}
    .tiny{font-size:12px;color:var(--muted);margin-top:10px}
    a.tiny{color:var(--muted);text-decoration:none}
  </style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">JOBSTRONAUT V2</h1>
    <p class="tagline">The universe is hiring — and it wants you. Drop your resume, auto-apply to matching roles, and let us co-pilot the follow-through.</p>

    <section class="grid">
      <!-- Left Card — Resume Upload -->
      <div class="card">
        <div class="chip">MVP</div>
        <h2 style="margin:0 0 4px">Resume Upload</h2>
        <p class="tiny" style="margin:0 0 14px">Max 10 MB. PDF is best for parsing.</p>

        <label class="label" for="resumeFile">Resume (PDF)</label>
        <input id="resumeFile" class="input" type="file" accept=".pdf,.doc,.docx,.txt,.rtf,.odt" />

        <label class="label" for="emailInput">Email (optional)</label>
        <input id="emailInput" class="email" type="email" placeholder="you@example.com" />

        <div class="row">
          <button id="uploadButton" type="button" class="btn btn-primary">⬆ Upload & Submit</button>
          <button id="browseButton" type="button" class="btn btn-ghost">🔎 Browse jobs (preview)</button>
        </div>

        <div class="tiny" id="uploadNote"></div>
      </div>

      <!-- Right Card — Console / Waitlist -->
      <div class="card">
        <div class="chip" style="background:rgba(147,197,253,.12);color:#a5d8ff;border-color:rgba(147,197,253,.35)">Console</div>
        <h2 style="margin:0 0 4px">Command Console</h2>
        <p class="tiny" style="margin:0 0 14px">Join the waitlist, check system status, and jump into applying.</p>

        <label class="label" for="waitlistEmail">Join waitlist</label>
        <input id="waitlistEmail" class="email" type="email" placeholder="you@example.com" />

        <div class="row">
          <button id="waitlistJoinBtn" type="button" class="btn btn-primary">Join waitlist</button>
          <button id="systemStatusBtn" type="button" class="btn btn-ghost">Check system status</button>
          <button id="openApplyBtn" type="button" class="btn btn-ghost">Open Apply</button>
        </div>

        <div class="row" style="margin-top:16px;gap:18px">
          <a class="tiny" href="/privacy" target="_blank" rel="noopener">Privacy</a>
          <a class="tiny" href="/terms" target="_blank" rel="noopener">Terms</a>
          <a class="tiny" href="/sitemap.xml" target="_blank" rel="noopener">Sitemap</a>
        </div>
      </div>
    </section>
  </main>

  <!-- ========================= SCRIPTS ========================= -->
  <script>
  // --- analytics helper (fixed braces)
  function track(e, p) { try { if (window.plausible) plausible(e, { props: p }); } catch (_) {} }

  // --- one-time: unregister any old service worker so fresh JS runs (safe to remove later)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations?.().then(regs => regs.forEach(r => r.unregister()));
  }

  // ---- Upload flow: /s3/presign -> POST to S3 (AES256 + Content-Type) ----
  async function uploadResume(file) {
    try {
      const note = document.getElementById("uploadNote");
      if (note) note.textContent = "Uploading…";

      // 1) presign from backend
      const presignRes = await fetch("/s3/presign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          filename: file.name,
          contentType: file.type || "application/octet-stream"
        })
      });

      if (!presignRes.ok) {
        const t = await presignRes.text();
        console.error("Presign failed:", presignRes.status, t);
        if (note) note.textContent = "❌ Presign failed — see Console.";
        return;
      }

      const { url, fields, key } = await presignRes.json();
      console.log("presign:", { url, fields, key });

      // 2) S3 form-data (policy fields first, then headers, then file)
      const fd = new FormData();
      Object.entries(fields).forEach(([k, v]) => fd.append(k, v));
      fd.append("Content-Type", file.type || "application/octet-stream");
      fd.append("x-amz-server-side-encryption", "AES256");
      fd.append("file", file);

      // 3) POST to S3
      const up = await fetch(url, { method: "POST", body: fd });

      console.log("status:", up.status);
      console.log("x-amz-bucket-region:", up.headers.get("x-amz-bucket-region"));

      const bodyText = await up.text(); // empty on success; XML on error
      if (!up.ok) {
        const code = (bodyText.match(/<Code>([^<]+)<\/Code>/i) || [])[1] || "";
        const msg  = (bodyText.match(/<Message>([^<]+)<\/Message>/i) || [])[1] || "";
        console.error("Upload failed:", code, msg, bodyText);
        if (note) note.textContent = `❌ Upload failed — ${code || 'see Console'}${msg ? `: ${msg}` : ''}`;
        return;
      }

      // 4) optional: notify backend that upload completed
      fetch("/apply-complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          filename: file.name,
          size: file.size,
          contentType: file.type || "application/octet-stream",
          key
        })
      }).catch(() => {});

      if (note) note.textContent = "✅ Upload successful!";
      track("resume_upload_success", { size: file.size, type: file.type });
    } catch (err) {
      console.error("Upload error:", err);
      const note = document.getElementById("uploadNote");
      if (note) note.textContent = "❌ Upload crashed — see Console.";
    }
  }

  // ---- Wire up UI after DOM is ready (prevents 'click not working')
  document.addEventListener("DOMContentLoaded", () => {
    const uploadBtn = document.getElementById("uploadButton");
    const fileInput = document.getElementById("resumeFile");

    if (uploadBtn) {
      uploadBtn.addEventListener("click", () => {
        const f = fileInput && fileInput.files && fileInput.files[0];
        if (!f) { alert("Please choose a file first."); return; }
        uploadResume(f);
      });
    }

    const waitBtn = document.getElementById("waitlistJoinBtn");
    const waitEmail = document.getElementById("waitlistEmail");
    if (waitBtn && waitEmail) {
      waitBtn.addEventListener("click", async () => {
        const email = waitEmail.value.trim();
        if (!email || !email.includes("@")) { alert("Enter a valid email."); return; }
        try {
          const r = await fetch("/waitlist/join", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ email })
          });
          alert(r.ok ? "Joined! 🚀" : "Could not join. Try again.");
          track("waitlist_join_attempt", { ok: r.ok });
        } catch {
          alert("Network error joining waitlist.");
        }
      });
    }

    const browseBtn = document.getElementById("browseButton");
    if (browseBtn) browseBtn.addEventListener("click", () => {
      track("browse_jobs_click");
      window.open("/jobs/preview", "_blank");
    });

    const statusBtn = document.getElementById("systemStatusBtn");
    if (statusBtn) statusBtn.addEventListener("click", () => {
      track("system_status_click");
      window.open("/status", "_blank");
    });

    const applyBtn = document.getElementById("openApplyBtn");
    if (applyBtn) applyBtn.addEventListener("click", () => {
      track("open_apply_click");
      window.location.href = "/apply";
    });
  });
  </script>

  <!-- (optional) plausible loader if you use it
  <script defer data-domain="jobstronaut.dev" src="https://plausible.io/js/script.js"></script>
  -->
</body>
</html>

